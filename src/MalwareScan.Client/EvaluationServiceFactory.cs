using System;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Net.Security;
using System.Security.Authentication;
using System.Security.Cryptography.X509Certificates;
using System.Text;

namespace MalwareScan.Client
{
	/// <summary>
	/// Contains methods for creating <see cref="IEvaluationService"/> instances.
	/// </summary>
	public static class EvaluationServiceFactory
	{
		/// <summary>
		/// Creates an HTTP client.
		/// </summary>
		/// <param name="clientCertificate">the client certificate to use</param>
		/// <param name="userName">the basic authentication user name</param>
		/// <param name="password">the basic authentication password</param>
		/// <param name="serverCertificateCustomValidationCallback">the callback method to use for server certificate validation</param>
		/// <returns>the HTTP client</returns>
		public static HttpClient CreateHttpClient(
			X509Certificate2 clientCertificate = null,
			string userName = null,
			string password = null,
			Func<HttpRequestMessage, X509Certificate2, X509Chain, SslPolicyErrors, bool> serverCertificateCustomValidationCallback = null)
		{
			#region Set up basic authentication, if specified

			AuthenticationHeaderValue authenticationHeader;

			if (userName == null)
			{
				authenticationHeader = null;
			}
			else
			{
				byte[] authenticationBytes = Encoding.ASCII.GetBytes($"{userName}:{password}");
				string authenticationBase64 = Convert.ToBase64String(authenticationBytes);
				authenticationHeader = new AuthenticationHeaderValue("Basic", authenticationBase64);
			}

			#endregion

			var httpClientHandler = new HttpClientHandler();

			if (clientCertificate != null)
			{
				httpClientHandler.ClientCertificates.Add(clientCertificate);
				httpClientHandler.ClientCertificateOptions = ClientCertificateOption.Manual;
				httpClientHandler.SslProtocols = SslProtocols.Tls12;
			}

			httpClientHandler.ServerCertificateCustomValidationCallback = serverCertificateCustomValidationCallback;

			var httpClient = new HttpClient(httpClientHandler, true);

			if (authenticationHeader != null)
			{
				httpClient.DefaultRequestHeaders.Authorization = authenticationHeader;
			}

			return httpClient;
		}

		/// <summary>
		/// Creates an evaluation service.
		/// </summary>
		/// <param name="url">the base URL of the service</param>
		/// <param name="httpClient">the HTTP client to use</param>
		/// <param name="type">the evaluation service type</param>
		/// <returns>the created evaluation service instance</returns>
		/// <remarks>
		/// In order to create an HTTP client instance, the <see cref="CreateHttpClient"/> method can be used.
		/// </remarks>
		public static IEvaluationService CreateEvaluationService(string url,
			HttpClient httpClient = null,
			EvaluationServiceType type = EvaluationServiceType.LatestMalwareScan)
		{
			if (url == null)
			{
				throw new ArgumentNullException(nameof(url));
			}

			IEvaluationService evaluationService;

			switch (type)
			{
				case EvaluationServiceType.MalwareScanV1:
					{
						evaluationService = new MalwareScanEvaluationServiceV1(url, httpClient);
						break;
					}
				case EvaluationServiceType.MalwareScanV1_1:
					{
						evaluationService = new MalwareScanEvaluationServiceV1_1(url, httpClient);
						break;
					}
				default:
					{
						throw new NotSupportedException($"Evaluation service type `{type}` is not supported in this context.");
					}
			}

			return evaluationService;
		}
	}
}
