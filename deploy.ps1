#Requires -Version 3.0

$BasePath = $(Resolve-Path -Path $PSScriptRoot)
$DeployPath = $(Join-Path -Path $BasePath -ChildPath ".deploy")
$Configuration = "Debug"
$Runtimes = ("win-x86", "win-x64", "linux-x64")

if (Test-Path -Path $DeployPath) {
	Remove-Item -Path "$DeployPath" -Force -Recurse
}

Write-Progress -Id 0 -PercentComplete 0 `
	-Activity "Building solution..." `
	-Status "dotnet build"
& dotnet build
Write-Progress -Id 0 -Completed `
	-Activity "Building solution..."

Write-Progress -Id 0 -PercentComplete 0 `
	-Activity "Publishing MalwareScan.Client..." `
	-Status "dotnet publish .\src\MalwareScan.Client"
& dotnet publish .\src\MalwareScan.Client --output "$DeployPath\MalwareScan.Client" `
	--configuration "$Configuration"
Write-Progress -Id 0 -Completed `
	-Activity "Publishing MalwareScan.Client..."

Write-Progress -Id 0 -PercentComplete 0 `
	-Activity "Archiving MalwareScan.Client..."
Compress-Archive -LiteralPath "$DeployPath\MalwareScan.Client" `
	-DestinationPath "$DeployPath\MalwareScan.Client-fdd.zip"
Write-Progress -Id 0 -Completed `
	-Activity "Archiving MalwareScan.Client..."

Write-Progress -Id 0 -PercentComplete 0 `
	-Activity "Packing MalwareScan.Client..." `
	-Status "dotnet pack .\src\MalwareScan.Client"
& dotnet pack .\src\MalwareScan.Client --output "$DeployPath" `
	--configuration "$Configuration"
Write-Progress -Id 0 -Completed `
	-Activity "Packing MalwareScan.Client..."

Write-Progress -Id 0 -PercentComplete 0 `
	-Activity "Publishing MalwareScan.ClientApp..." `
	-Status "dotnet publish .\src\MalwareScan.ClientApp"
& dotnet publish .\src\MalwareScan.ClientApp --output "$DeployPath\MalwareScan.ClientApp\fdd" `
	--configuration "$Configuration"
Write-Progress -Id 0 -Completed `
	-Activity "Publishing MalwareScan.ClientApp..."

Write-Progress -Id 0 -PercentComplete 0 `
	-Activity "Archiving MalwareScan.ClientApp..."
Compress-Archive -LiteralPath "$DeployPath\MalwareScan.ClientApp\fdd" `
	-DestinationPath "$DeployPath\MalwareScan.ClientApp-fdd.zip"
Write-Progress -Id 0 -Completed `
	-Activity "Archiving MalwareScan.ClientApp..."

foreach ($Runtime in $Runtimes) {
	Write-Progress -Id 0 -PercentComplete 0 `
		-Activity "Publishing MalwareScan.ClientApp for $Runtime..." `
		-Status "dotnet publish .\src\MalwareScan.ClientApp --runtime `"$Runtime`""
	& dotnet publish .\src\MalwareScan.ClientApp --output "$DeployPath\MalwareScan.ClientApp\$Runtime" `
		--configuration "$Configuration" `
		--runtime "$Runtime"
	Write-Progress -Id 0 -Completed `
		-Activity "Publishing MalwareScan.ClientApp..."

	Write-Progress -Id 0 -PercentComplete 0 `
		-Activity "Archiving MalwareScan.ClientApp for $Runtime..."
	Compress-Archive -LiteralPath "$DeployPath\MalwareScan.ClientApp\$Runtime" `
		-DestinationPath "$DeployPath\MalwareScan.ClientApp-$Runtime.zip"
	Write-Progress -Id 0 -Completed `
		-Activity "Archiving MalwareScan.ClientApp for $Runtime..."
}
